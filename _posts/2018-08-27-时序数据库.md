---
layout:     post
title:      时序数据库
subtitle:   时序数据库比较
date:       2018-08-27
author:     李俊阳
catalog: true
tags:
    - 时序数据库
    - prometheus
    - influxdb
---

# 时序数据库初探

##### 一、关系型数据与时序数据库的比较

时序数据库的概念：

时序数据库（Time Series Database）是用于存储和管理时间序列数据的专业化数据库，为时间序列数据提供高性能读写和强计算能力的分布式数据库服务。时序数据库特别适用于物联网设备监控和互联网业务监控场景。 



​						关系数据库代表MySql,和时序数据库influx db的比较

|   比较指标   | 关系数据库（MySql） | 时序数据库(influx db) |
| :----------: | :-----------------: | :-------------------: |
| 数据存储规模 |       百万级        |      轻松千万级       |
|   实现机制   |       B+Tree        |       LSM_Tree        |
|    吞吐量    |        一般         |          高           |
|    延迟性    |        一般         |          低           |
|    扩展性    |        一般         |          高           |
|    事务性    |        支持         |          否           |
|    一致性    |         高          |         一般          |

根据以上特点，可知：

- 关系数据库，比较适合数据量规模并不是很大，读多写少，对吞吐性，读写延迟不是很高，一致性要求高的场景。
- 时序数据库，适合巨量数据规模，读少写多，读写延迟低，数据一致性要求不高，即便丢失数据也不影响业务的场景。

##### 二、时序数据特点

- 时间序列数据
  - 这类数据描述了某个被测量的主体在一个时间范围内的每个时间点上的测量值 。
- 数据写入平稳、持续、高并发
  - 时序数据是以某个固定频率采样而产生的，不会受其他因素制约。
  - 写多读少。
  - 实时写入最近的数据，无更新。
- 数据查询以时间范围
  - 不会具体到某个点上的数据，以采样间隔多精度查询。
- 数据量大，冷热分明，多精度数据存储
  - 整个数据的规模，是TB甚至是PB级的 ，历史数据分析价值有限，通常有保存周期，时效性强。

##### 三、基于时序数据特点对时序数据库的基本要求

- 能够支撑高并发、高吞吐的写入 
  - 受采样频率要求，持续的写入能力要求很高。
- 交互级的聚合查询 
  - TB级为基准线的聚合查询，要保证低延迟。
- 支持海量数据存储
  - 根据其时间采样特点，一定是巨量的数据规模。
- 分布式
  - 根据其上要求，单机必然无法支持，分布式是必然的。

##### 四、时间序列数据的模型

时间序列数据定义：描述了某个被测量的主体在一个时间范围内的每个时间点上的测量值 。

- 主体
- 时间范围
- 测量值

以关系型数据库表为例介绍其数据模型

假如：有一组监控数据，记录主机的CPU使用率(%)，内存使用情况，每10s采取一次。

表结构一般我们会如下2种设计。

- 以时间(数据源)为维度

| 时间                | 主机名字 | CPU使用率(%) | 内存使用率(%) |
| ------------------- | -------- | ------------ | ------------- |
| 2018-08-01 00:00:10 | 上海主机 | 10           | 30            |
| 2018-08-01 00:00:20 | 上海主机 | 20           | 50            |
| 2018-08-01 00:00:30 | 上海主机 | 15           | 40            |

- 以指标为维度

| 指标名字      | 时间                | 主机名字 | 指标值 |
| ------------- | ------------------- | -------- | ------ |
| CPU使用率(%)  | 2018-08-01 00:00:10 | 上海主机 | 10     |
| 内存使用率(%) | 2018-08-01 00:00:10 | 上海主机 | 30     |
| CPU使用率(%)  | 2018-08-01 00:00:20 | 上海主机 | 20     |
| 内存使用率(%) | 2018-08-01 00:00:20 | 上海主机 | 50     |
| CPU使用率(%)  | 2018-08-01 00:00:30 | 上海主机 | 15     |
| 内存使用率(%) | 2018-08-01 00:00:30 | 上海主机 | 40     |

两种数据模型并无优劣，只是时序数据库的两种常用数据模型。各家会有不同的底层实现，根据实现不同，选择合适的数据模型。

##### 五、时间序列数据的处理

数据的处理，一般基本的数据处理操作基本涵盖以下几个方面：

- 过滤
- 聚合
  - 求和
  - 平均
  - 最大
  - 最小
  - 分组

时序数据库会有几个预处理的操作，在写入数据的时候，方便下次直接查询，不用计算。比如：

降精度处理，上面例子中每10s采样，写入，时序数据库会在1min时，把前6次采样结果自动汇总，写入数据库。

##### 六、常见的时序数据库

根据DB Engine google 排名搜索 tsdb(time serial database),使用率最高的时序数据库，截取前10名如下：

![时序数据库排名](https://juylee.github.io/img/20180827/时序数据库排名.png)

这里主要介绍InfluxDB、OpenTSDB、Prometheus、Druid，分析它们的特点，作为技术选型的参考。

- 未开源
  - Kdb+、eXtremeDB
- 历史数据被覆盖
  - RRDtool(ROUND ROBIN Database) ，即循坏存储数据库，数据库空间给定，不符合我们的监控场景。
  - Graphite 增强版的RRD

|                      | InfluxDB | OpenTSDB              | Prometheus        | Druid      |
| -------------------- | -------- | --------------------- | ----------------- | ---------- |
| 时序数据模型存储引擎 | TSM      | 基于HBase存储时序数据 | Prometheus V3引擎 | 列式数据库 |
| 写入和存储能力       | 高       | 高                    | 高                | 高         |
| 查询和分析能力       | 高       | 高效查询场景覆盖不够  | 高                | 高         |
| 集群限制             | 商业版   | 无                    | 无                | 无         |
| 是否提供类SQL查询    | 是       | 否                    | 否                | 是         |
| 实现语言             | Go       | Java                  | Java              | Go         |
| 是否支持Java         | 是       | 是                    | 是                | 是         |

##### 七、Prometheus介绍

1. 特点：

- Prometheus是一个开源的系统监控和报警工具 。
- 多维数据模型(时间序列数据由metric名 和 一组key/value组成)
- 灵活的多维度查询语言(PromQL)
- 通过Pull方式拉取数据
- 提供pushgateway推送数据
- 采集数据可通过服务发现或者静态配置
- 支持集群(一般没必要，高的可靠性，单实例满足需求)
- 自带图表视图，支持其他视图拓展(Grafana)
- 使用自研的存储引擎，无其他依赖

2.架构

![architecture-cb2ada1ece6](https://juylee.github.io/img/20180827/architecture-cb2ada1ece6.png)

3.数据模型

​	样板:<metric name>{<label name>=<label value>, ...}

​	例子：api_http_requests_total{method="POST", handler="/messages"}

​	其中，api_http_requests_total为指标名字，l{method="POST", handler="/messages"}为标签属性。

4.指标类型

​	Prometheus提供4个核心的指标类型，支持Java，Go等多客户端。

| 指标类型  | 释义                                             | 使用举例               |
| --------- | ------------------------------------------------ | ---------------------- |
| Counter   | 累积指标类型，只能增加，重启归零。               | 监控一段时间的请求总数 |
| Gauge     | 可任意更改地可增可减指标类型。                   | 监控温度或者内存使用率 |
| Histogram | 监控一个时间段的值，也可统计一个时间段的总数     | 监控请求返回时间       |
| Summary   | 跟Histogram类似，区别在于计算Quantiles的方式不同 | 同上                   |

5.作业和实例

- 实例
  - 爬取的端点称为实例
- 作业
  - 收集一组实例，用于监控

例如：

job: 

```
api-server
```

- instance 1: `1.2.3.4:5670`
- instance 2: `1.2.3.4:5671`
- instance 3: `5.6.7.8:5670`
- instance 4: `5.6.7.8:5671`

当Prometheus爬取目标时，自动绑定job和instance标签到时间数据中。

- job 目标属于配置的作业名字

- instance 被爬取的目标的url中的 ip:port

  









